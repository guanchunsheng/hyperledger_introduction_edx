# 第一章 探索区块链技术

## 介绍

第一章介绍分布式账本的区块构建，以及区块链的构建。这一章是本教程的基础，用以深入的理解后续章节。需要通过本章的学习来提高对区块链知识的理解。

## 学习目标

学完本章后，应该可以：

* 讨论区块链和分布式账本技术（DLT）
* 探讨permissioned和permissionless类型的区块链及其特点
* 讨论分布式账本技术的各个组件，包括共识算法和智能合约
* 从比较高的层级解释什么是超级账本

## 背景

### 兴味盎然的分布式账本技术

回顾过去半个世纪的计算机技术和结构的发展，可以看到一个趋势，那就是计算能力、存储、基础设施、协议以及代码，从集中式向分布式的转变。

大型计算机是高度中心化的。它们通常集中了所有的计算能力、内存、数据存储和代码。访问大型计算机主要通过”哑终端“来进行，只包含输入和输出，并不存储和处理数据。

随着个人计算机和私有网络的到来，类似的计算能力现在同时分布在服务器和客户端上。这在某种程度上催生了“客户机-服务器”体系结构，它支持关系数据库系统的开发。在大型计算机上维护的海量数据集，现在可以转移到分布式的结构上。数据可以在服务器之间复制，数据的子集可以在客户端上访问和处理，然后再同步回服务器上 。

随着时间的推移，互联网和云计算架构支持从各种计算设备进行全局访问，而大型机主要是针对大型企业和政府的需求。尽管这种“云架构”在硬件方面是分散的，但它产生了应用程序本身的集中化，比如脸书，推特和谷歌等。

目前，我们正见证从集中式的计算、存储和处理向分布式体系结构和系统的转变。

根据[Muneeb Ali](https://medium.com/@muneeb/the-next-wave-of-computing-743295b4bc73) 所说，这些系统的目标是：

> ”将数字资产的控制明确的交给终端用户，无须相信任何第三方服务器和基础设施“

分布式账本技术是促成这个转变的关键性创新。

## 分布式账本技术（DLT）

**分布式账本**是一类数据结构，在多个计算设备之间分布，通常位于不同的位置和区域。

**分布式账本技术**包括区块链技术和智能合约。分布式账本技术先于比特币就已经存在，比特币将交易时间戳、P2P网络，密码学和共享算力、一种新的共识算法与分布式账本结合在了一起。

总的来说，分布式账本技术包含3个基本组件：

* **数据模型** - 捕获账本的当前状态
* **交易语言** - 改变账本状态
* **协议** - 在参与方之间就交易是否被账本接受以及按照什么顺序记录，达成共识

## 访谈

Robert Schwentker

> **主持人**：Robert，什么是区块链技术？
>
> **Robert**：区块链是一个P2P的分布式账本，通过共识，结合智能合约系统和其他辅助性的技术组成。
>
> 这些东西在一起可以构成新一代的交易应用，可以建立信任，可问责性和它们核心的透明性，这将简化业务流程和法律约束。
>
> 所有的分布式账本都有第一个区块，或者叫创世区块。每个区块都会包含一个或者多个交易。连接到一个区块链等同于相关的人通过应用连接到这个分布式账本。
>
> 所以一个例子就是钱包。
>
> 一个人可以将数字资产比如密码学货币转账给另一个人，这样资产就从一个人的钱包转移到了另一个人的钱包，然后这个交易就被记录到区块链里。之后这笔分布式账本交易通过P2P网络传递给全网，没有中介机构比如银行或者支付公司来处理这笔交易。
>
> **主持人**：你能给出一个近年来实际在应用的区块链产品么？
>
> **Robert**：当然，区块链通过比特币被大家熟知。比特币区块链从2009年开始就存在了。比特币是一种密码学货币，但有趣的是，人们混淆了2个术语，比特币不等于区块链，区块链也不等于比特币。
>
> 区块链是一种分布式的账本，追踪各种资产，不同于密码学货币比如比特币。这些交易被打包到区块中，每个区块可以包含任意数量的交易。结果就是，区块链网络中的节点或者机器将这些交易打包并且通过网络发出。
>
> **主持人**：你已经提到了区块链在P2P节点中是怎么处理的，那么它们是怎么同步起来的呢？
>
> **Robert**：区块链同步是通过共识的概念完成的，共识是在网络节点之间达成一致的意思。所以最终，网络中的每一个机器都获得了一份正确的区块链拷贝。

## 区块链

根据 [hyperledger.org](https://hyperledger.org/about) 的定义：

> “区块链是一个P2P的分布式账本，通过共识，结合智能合约系统和其他辅助性的技术组成”

**智能合约** - 当系统内的特定条件满足时，可以执行的预定义好的计算机程序

**共识 **- 指的是确保参与方都同意系统的某个状态是真实有效的状态

**区块链**是分布式账本技术的一个特别的术语或子集，由有序的区块链接而成，所以叫“区块链”。

**区块**表示绑定在一起的一组交易，在同一时间加入到链中。在比特币区块链中，矿工节点打包未确认但是有效的交易到一个块中。每个块包含一定数量的交易。在比特币网络中，矿工必须解出一个密码学的难题来获得下一个块的记录权。这个过程称为“工作量证明”，需要很大的计算能力。我们将在共识算法章节讨论工作量证明的问题。区块链技术的简明历史，请参考[这里](https://hbr.org/2017/02/a-brief-history-of-blockchain)。

时间戳是区块链技术的另一个关键特性。每个区块都有时间戳，新的区块都指向前一个区块。结合密码学的**哈希**，这样的带有时间戳的链接在一起的区块，提供了从创世区块开始的，在网络中无法修改已经写入的交易记录的能力。

一个区块通常包含4类元数据：

* 指向前一个区块的索引
* 工作量证明，也叫nonce
* 时间戳
* 这个区块内含的交易的Merkle树

### Merkle树

The word 'tree' is used to refer to a branching data structure in computer science, as seen in the image below. According to Andreas M. Antonopoulos, in the Bitcoin protocol,

Merkle树也叫二进制哈希树，是一种数据结构，按照特别的方式记录一个大型数据集中单个数据的哈希，用于高效验证这个数据集。它是一种防篡改机制，以确保大数据集没有被更改。“树”一词指的是计算机科学中的分支数据结构，如下图所示。Andreas M. Antonopoulos认为，在比特币协议中：

> “Merkle树用来汇总一个区块中所有的交易，对于所有交易组成的集合生成一个整体的数字指纹，对于验证区块中是否包含的特定的交易非常高效”

![](/assets/Bitcoin_Block_Data.png)上图为比特币区块数据。

对Merkel树的更深入讨论，请见[http://chimera.labs.oreilly.com/books/1234000001802/ch07.html\#\_structure\_of\_a\_block\)](http://chimera.labs.oreilly.com/books/1234000001802/ch07.html#_structure_of_a_block%29)

## 访谈

DLT和区块链的区别 - Brian Behlendorf

> **主持人**：分布式账本技术和区跨链的区别是什么呢？
>
> **Behlendorf**：术语分布式账本和区块链的区别在外界看来非常晦涩。对我个人来说，分布式账本是一个非常好的，非常特别的方式来描述这种分布式的数据库。在这个系统中，你、我和其中的每个人都同步的保有一些列交易的拷贝。
>
> 对于这样的数据结构的术语表述就是区块链，但是现在大家都用区块链这个词代表了密码学货币，企业中部署的DLT等。
>
> 所以我认为区块链就像是Internet一样，含义太宽泛了。但是能够在这里介绍DLT甚至智能合约功能这样的新技术，也是极好的。

什么是区块链 - Dave Huseby

> 主持人：那么，什么是区块链呢？
>
> Huseby：作为超级账本的安全专家，关于区块链我有一些不同角度的看法。
>
> 我最初是一个开发者，并且我会用一种对抗的方式去看世界。通常是我的软件和真实世界的对立。
>
> 对我来说，区块链无疑为解决困扰我们许多年的问题打开了另一个解决的可能性。可以通过很多方式在分开的各部分之间建立分布式的共识，也允许我们建立一个即时的唯一真实。
>
> 过去，我们总是被“一天的时间中到底发生了什么”这样的问题困扰.
>
> 银行核对账簿，库存系统清理销售和交货记录…
>
> 通过区块链，我们实时的记录事物，这为我们提供了一种即时记录世界的状态的方法。
>
> 所以，很多上面的旧系统都可以滚蛋了，不再需要这么多的系统管理的工作量了。我们再也不用在夜里批处理任务了。
>
> 取而代之的是，我们可以实时做验证，我们总是可以知道世界状态。
>
> 这为应用的部署提供了一个新的方式，比如如果我们明确的知道螺栓在哪里，那么是不是可以说需要他们的时候提前2分钟确定他们还在那里就行了，就像精益制造一样。
>
> 但是它也可以应用到所有我们需要追踪物料和人工，资金等等领域。
>
> 所以对我来说，区块链就是重新审视现有业务流程的东西，如果我们能够即时了解世界状态，那么我们用区块链是不是可以提升效率，不用等2分钟，2个小时甚至必须等到一天结束。
>
> 这其实是一种从人的尺度到计算机尺度的转换，通过区块链，我们现在可以即时的处理这些流程，因为机器就是这么工作的。
>
> 从安全的角度看，区块链不是银弹。它们不会替代现有的业务逻辑。更准确的说他们是日志系统，记录发生了什么，就在发生的时候，而不是从顾客口袋里掏钱的工具。
>
> 它不是软件类型的业务流程，因为它是日志，也以内它是真实，因为很多其他业务逻辑将会建立在它之上，所以跟它相关的安全性跟现有业务逻辑是一样的。
>
> 必须认为分布式账本的参与者都在一个封闭的网络中，因为事实如此，至少是permissioned网络。
>
> 我们不会在开放的网络中运行，不会在trustless环境中运行，而是在permissioned网络中，就好象是在一个私有网络中一样。
>
> 所以当部署区块链软件的时候，通常是在防火墙后面，如果多个组织参与到分布式账本中，我们会使用隧道技术和其他VPN防火墙，通过虚拟VPN为其他组织链接。
>
> 不同的超级账本项目有不同的权衡。比如Fabric具有更中心化的排序服务，需要按照hub-and-spoke模型组网，也就是说每个peer节点连接到排序服务，运行在其中一个节点上，或者一个中立的第三方。
>
> 所有的gossip消息通过中央的hub来做共识机制。这样看起来也不是分布式的呀，其实是的，因为区块链本身是在所有的节点上复制的，所以你的数据是容灾的。协作是可以在一个相对中心化的方式来做的。
>
> 主持人：那么Sawtooth呢，不是这样的吧？
>
> Huseby：Sawtooth的网络更像是一个星形模型。可以选择一部分节点，将你的节点连接进去，然后只要节点连接没问题，那么你可以最终和每个节点沟通，通过1跳，2跳或者3跳等等，根据你的网络的规模。
>
> 至于Iroha，它们的拓扑跟其他的很不一样，因为他们是根据移动环境特别设计的分布式账本，很多客户端间歇式的连接在一起。
>
> 所以他们的手机可以随时连上或断开。
>
> 所以他们的结构更像是一个分层网络，终端用户的客户端手机向服务器提交交易，然后在服务器之间做分布式的账本。
>
> 所以没有定论是吧，没有完全伟光正的方案。
>
> 业务流程决定了你怎么选，但是安全性都是同样重要的。
>
> 我们用加密和数字签名来验证消息，所以篡改消息是不可能的。
>
> 分布式账本的不可修改性是通过密码学来保证的，但是这也依赖于网络的可信性，跟我们处理其他后台服务一样。
>
> 需要像其他网络服务一样，需要将它部署在防火墙之后，使用隧道技术连接节点，处理网络拥堵，负载均衡等等。
>
> 关于安全性，我想说的就是这些，然后谢谢参与本课程。

## 交易

区块链里边的**交易**，指的是将事件的记录，通过数字签名技术从密码学上进行安全保护，将这样的记录验证、排序并且打包到一个个区块中。在比特币区块链中，交易包括比特币的转账，而在其他的区块链中，交易可能还包括任意资产的转移，或者提供某些服务。更进一步，区块链中的智能合约可以在满足既定条件的时候自动的去执行交易。

**密码学**在区块链安全性和记录不可修改的特性中起到了核心作用。密码学是研究不同通信方之间保证通信机密性和完整性的技术。对于区块链技术来说，密码学用以证明交易是由正确的人创建的。同时密码学可以将交易用防篡改的方式将区块链接到一起，即区块链。

## 区块链和数据库的区别

区块链和数据库技术有一些很关键的区别。

区块链是一种只写的数据结构，新的条目只能添加到账本的末尾。每一个新的区块都是通过链接前一个区块的哈希，添加到前一个区块末尾的。不存在管理员权限，不允许编辑和删除数据。

在关系型数据库中，数据可以轻易的编辑和删除。通常有管理员可以改变任何部分的数据或结构。

此外区块链的设计是针对分布式的应用，而关系型数据库通常是为了集中式的应用而设计的，只有单一的入口来控制数据。

![](/assets/Centralized_Databases_vs_Blockchain.png)

## 区块链的类型

![](/assets/Types_of_Blockchains.png)

区块链可以是无权限限制的（permissionless，比如比特币和以太坊），也可以是具有权限限制的（permissioned，比如各种超级账本框架）。无权限限制的区块链也叫公链，因为任何人都可以加入网络。有权限限制的区块链，也叫私链，需要提前验证网络中的参与者，而且这些参与者一般是互相知道的。

是选择公链还是私链取决于特定的业务。大多数的公司用例，在彼此同意展开业务之前，需要进行审核。不同业务需要进行信息交换的一个例子是供应链管理。供应链管理是一个典型的具有权限限制的区块链用例。你肯定不会想要未经审核的公司参与到网络中来。参与进来的每一方，在区块链上执行交易之前，都需要经过授权。这些交易能够让其他公司了解到供应链中具体某个东西现处何地。

相反的，如果将信任本身商品化能够便于网络中参与方自由的进行交互，而不必关注彼此的身份，就比如比特币那样，那么公链是更合适的。面向公众的销售和零售就是这样的例子。密码学货币和ICO（首币发行）通常是通过公链实现的。

## P2P网络结构

以前多数应用都是使用的中心服务器。用户/客户端向另一个用户/客户端发出消息的时候，这个请求是首先发到hub或者中心服务器上的，然后才会被转发到真正的目的计算机。

P2P网络先是由于Napster（以及后来的BitTorrent）流行起来的，由Internet上直接相互连接起来的计算机组成的系统，并没有中央服务器。对等节点（peer）贡献出维持网络所需的计算和存储能力。一般认为P2P网络是比中心化的网络更安全的，因为它不会被单点攻击摧毁，中心化的网络中如果中央服务器被攻陷了，那么网络就瘫痪了。所以大公司都重金保护他们的中央服务器，同时每年还有大量的损失是由于这样的攻击造成的，世界经济论坛 2016 Global Risk Report估计损失高达4.45亿美元。

无权限限制的P2P系统不需要一定数量的peer保持在线，一般来说是比较慢的。有权限限制的P2P网络不要保证一定的在线和通信链路的质量。

![](/assets/Network_Architectures.png)

## 访谈

Robert Schwentker

> 主持人 ：什么是P2P网络，peer是怎么对区块链上的东西达成一致的呢？
>
> Roberts： 区块链网络就是一组计算机，按照P2P结构组织在一起的。共识是peers就区块链上的数据进行同步的过程。有一些共识机制和算法。一个是工作量证明，一个是权益证明。还有时间流逝证明，简化拜占庭容错等等。
>
> 比特币使用的是工作量证明，以太坊现在是工作量证明，正在转到权益证明上。超级账本的Sawtooth用的是时间流逝证明

## 永久性数据

区块链中的永久性数据可能是区块链方案能够替代传统的由中央服务器记录各种社会经济数据的方案的优势。永久性，或者说不变性，使得区块链对于会计，金融交易，身份管理和资产所有权，资产管理和转移都具有很大的作用。一旦一个交易写进了区块链，那么谁都不能修改，至少是非常难以修改。

据R3 研究主任![Antony Lewis](https://www.linkedin.com/pulse/gentle-introduction-immutability-blockchains-antony-lewis/)所说：

> "当人们说区块链是永久性的时候，不是说完全改不了，而是说要完成非碰撞的修改，是极难的，而且如果尝试这么做了的话，是很容易发现有人试图修改的"

再深入一点。极难修改区块链中的一个交易，因为每个区块都链接到了前一个区块。如果单独一个交易想要修改，那么不仅Merkle树根会变，而且交易所在的区块包含的哈希就跟着变，还有后续的区块都需要按照新的哈希来修改。在使用工作量证明的情况下，重新计算这个区块和后续所有区块的nonce所需的算力是不可能实现的。另外，如果不修改后续的区块，单纯修改交易所在区块，这是很容易发现的，重新做一下哈希运算就知道事情不对了。

我们看个例子。下图中我们看到区块11的原始区块和交易，Merkle树根是Hash \#ABCD，是这个区块的4个交易的联合哈希。现在假设有人想把交易A改成交易A'，这将改变Merkel树中保存的哈希，Merkle树根会变成A'BCD。在区块12中保存的前一区块哈希，需要根据区块11的新哈希值进行更新。

![](/assets/BLOCKCHAIN_IMMUTABILITY.png)

